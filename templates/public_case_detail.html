{% extends "base.html" %}
{% block title %}Case ‚Äî {{ r.case_name or r.name_of_party }}{% endblock %}
{% block head %}
<style>
  :root{ --sheet-bg:#fff; --sheet-bd:#eaeaea; --soft:0 10px 28px rgba(0,0,0,.08); --orange:#ff7a00; }
  .page-wrap{ display:grid; grid-template-columns: 1fr; gap:16px; align-items:start; }
  .has-panel .page-wrap{ grid-template-columns: 320px minmax(0,1fr); }
  .side-panel{
    display:none; border:1px solid #eee; border-radius:14px; background:#fff;
    box-shadow: var(--soft); padding:12px; position:sticky; top:14px;
    max-height: calc(100dvh - 28px); overflow:auto;
    font-size:13px;
  }
  .side-panel .crit{ font-weight:700; margin:0 0 6px 0; color:#111; border-bottom:1px solid #eee; padding:0 0 6px 0; }
  .side-panel h4{ margin:0 0 6px 0; font-size:16px; font-weight:700; color:#111; }
  .side-panel .mini{ display:flex; flex-direction:column; gap:8px; }
  .side-panel .mini .item{ border:1px solid #eee; border-radius:10px; padding:10px; background:#fafafa; }
  .side-panel .mini .item .row{
    display:grid; grid-template-columns: 70px 1fr; gap:6px; font-size:12px; margin:2px 0; align-items:start; line-height:1.3;
  }
  .side-panel .mini .item .row b{ color:#444; font-weight:600; }
  .panel-case{ display:inline-block; font-weight:600; color:var(--orange); text-decoration:none; margin-bottom:4px; font-size:12px; }
  .panel-case:hover{ text-decoration:underline; }
  .sheet{background:var(--sheet-bg);border:1px solid var(--sheet-bd);box-shadow:var(--soft);border-radius:16px;padding:20px}
  .top-row{display:flex;align-items:center;gap:10px;margin-bottom:10px; position:relative; z-index:5;}
  .spacer{flex:1}
  .print-btn,.back-btn{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid #dadada;background:#fff;cursor:pointer;font-weight:700;
    box-shadow:0 4px 10px rgba(0,0,0,.06);transition:transform .06s ease, box-shadow .12s ease, background .12s ease
  }
  .print-btn:hover,.back-btn:hover{background:#f7f7f7;box-shadow:0 6px 16px rgba(0,0,0,.1)}
  .print-btn:active,.back-btn:active{transform:translateY(1px)}
  .print-icon{width:20px;height:20px}
  .hero-case{border:1px solid #efefef;border-radius:14px;padding:16px;margin-bottom:12px;background:linear-gradient(180deg,#fff 0%,#fafafa 100%)}
  .case-no{font-weight:800;color:#111}
  .case-no strong{color:var(--orange)}
  .party-name{font-weight:800;font-size:28px;line-height:1.15;margin-top:6px;background:linear-gradient(92deg,#111 0%,#333 45%,#111 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
  .meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;align-items:center;color:#222;font-weight:700}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f6f6f6;border:1px solid #ececec;font-size:12px;color:#111}
  .pill .dot{width:6px;height:6px;border-radius:50%;background:var(--orange);display:inline-block}
  h3.section{margin:14px 0 8px 0;font-size:18px;font-weight:900;color:#111}
  .box{background:#f9fafb;border:1px solid #ededed;border-radius:14px;padding:16px;margin-bottom:12px}
  .pad-left{padding-left:14px}
  .section-divider{height:1px;background:#000;margin:12px 0}
  .prose,.prose *{ font-family:"Aptos","Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif !important; font-size:12pt !important; line-height:1.5 !important; color:#111 !important; text-align:justify; }
  .prose img{max-width:100%;height:auto}
  .prose table{border-collapse:collapse;margin:8px auto}
  .prose table td,.prose table th{border:1px solid #ddd;padding:6px}
  .fullcase.prose{white-space:normal !important; max-height:60vh; overflow:auto;}
  .fullcase.prose p,.fullcase.prose li,.fullcase.prose h1,.fullcase.prose h2,.fullcase.prose h3,.fullcase.prose h4,.fullcase.prose h5,.fullcase.prose h6,.fullcase.prose div{margin:6pt 0 !important}
  .fullcase.prose *:empty{display:none}
  .fullcase.prose br+br{display:none}
  .fullcase.prose p:has(br){margin:6pt 0 !important}

  /* PRINT */
  .print-first-header { display:none; }

  @media print {
    @page {
      margin: 20mm 16mm 30mm 12mm;
      @top-left { content: none; }
      @top-center { content: none; }
      @top-right { content: none; }
    }
    header.topbar { visibility: hidden; }
    header.topbar img {
      visibility: visible;
      position: fixed;
      top: 10mm; right: 16mm;
      width: 18mm !important; height: auto !important;
      opacity: 0.9; z-index: 1000;
    }

    @page {
      @bottom-center {
        content: "www.acergst.com | Page " counter(page);
        font-family: sans-serif; font-size: 15px; color: #555; white-space: nowrap;
      }
    }
    *{ -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; box-shadow:none !important; }
    body, .sheet, .box, .hero-case, .pill, .prose table, .side-panel, .top-row, .print-btn, .back-btn{ background:transparent !important; }
    .hero-case, .box, .sheet{ border-color:#ccc !important; border-radius:0 !important; }
    .party-name{ background:none !important; color:#000 !important; -webkit-background-clip:initial !important; background-clip:initial !important; font-weight:600 !important; font-size:22px !important; text-align:center !important; margin:8px 0 !important; }
    .case-no{ font-weight:600 !important; color:#000 !important; text-align:center !important; margin:0 auto; display:block; width: fit-content; padding:0; }
    .case-no strong{ color:#000 !important; }
    .hero-case { text-align: center; padding:12px !important; }
    .pill{ border-color:#ccc !important; }
    .pill .dot{ background:#000 !important; }
    .section-divider{ background:#000 !important; }
    .print-page-head{ display:none !important; }
    .topbar,.footer,.back-btn,.print-chooser,.top-row,#printBtn,.side-panel{display:none !important}
    .sheet{border:0; padding:0}
    .print-brand{ display:none !important; }
    #section-fullcase { page-break-before: avoid; }
    #section-fullcase > h3.section { display: none; }
    .fullcase.prose, #fullCase{ max-height:none !important; overflow:visible !important; }
    .prose table, .box table { break-inside: avoid; page-break-inside: avoid; }
    .prose tr, . prose td, .prose th, . box tr, .box td, . box th { break-inside: avoid; page-break-inside: avoid; }
    .prose h1, .prose h2, . prose h3, .prose h4, .prose h5, .prose h6,
    .fullcase h1, .fullcase h2, .fullcase h3, .fullcase h4, .fullcase h5, .fullcase h6,
    h3. section {
      break-after: avoid;
      page-break-after: avoid;
      orphans: 3;
      widows: 3;
    }
    .prose p, .prose li, .prose div, .fullcase p, .fullcase li, .fullcase div {
      orphans: 3;
      widows: 3;
    }
    body::before{
      content:"{{ r.case_law_number }}";
      position:fixed; top:55%; left:50%;
      transform:translate(-50%,-50%) rotate(-25deg);
      font-size:32pt; font-weight:800; color:#000; opacity:.05;
      z-index:-1; pointer-events:none; white-space:nowrap; line-height:1;
    }
    .print-endcase{ display:block !important; margin:4mm 0 0 0; text-align:center; }
    .print-endcase hr{ border:none; border-top:1px solid #000; margin:0 0 2mm 0; }
    .print-endcase .case{ font-size:11px; }
    .meta { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-top:8px; color:#222; font-weight:600; font-size:11px; }
    .pill { font-size:11px; padding:4px 8px; border-radius:8px; }
    .pill .dot { width:5px; height:5px; }
  }
  @media (max-width: 1100px){
    .has-panel .page-wrap{ grid-template-columns: 1fr; }
    .side-panel{ position:static; max-height:none; }
  }
  .print-brand { display: none; }
  @media print { .print-brand { display: none !important; } }

  /* highlight in detail view */
  .hl{ background:var(--orange-faint); border-radius:3px; padding:0 2px; }

  /* Print choice modal */
  .print-modal-overlay{
    position:fixed; inset:0; z-index:1400;
    background:rgba(0,0,0,0.35);
    display:none; align-items:center; justify-content:center;
  }
  .print-modal{
    background:#fff; border-radius:14px; padding:18px 20px;
    box-shadow:0 14px 36px rgba(0,0,0,0.16);
    max-width:380px; width:92%;
    border:1px solid #e5e5e5; text-align:left;
  }

    @media print {
    .print-modal-overlay{ display:none !important; }
    body.print-headnotes-only #section-headnotes ~ * { display:none !important; }
  }
  .print-modal h4{ margin:0 0 10px 0; font-size:16px; font-weight:700; color:#111; }
  .print-modal .choice{ display:flex; gap:8px; align-items:center; margin:8px 0; }
  .print-modal .actions{ margin-top:14px; display:flex; gap:10px; justify-content:flex-end; }

  /* AI Summary box tweaks */
  #aiSummaryBox { display:none; }
  /* Use normal flow (not pre-wrap) and tighten margins just for the AI box */
  #aiSummaryContent { white-space: normal; }
  #aiSummaryContent p  { margin: 6pt 0 !important; }
  #aiSummaryContent h4 { margin: 8pt 0 4pt !important; font-weight: 700; }

</style>
{% endblock %}
{% block content %}
<div class="container {% if search_summary or list_results or all_results or results %}has-panel{% endif %}">
  <div class="page-wrap">
    <!-- Left Panel -->
    <aside class="side-panel" {% if search_summary or list_results or all_results or results %}style="display:block"{% endif %}>
      {# --- BUILD SEARCH CRITERIA IF search_summary IS MISSING (AI path) --- #}
      {% set _q = request.args.get('q') or request.args.get('ai_q') %}
      {% set _industries = request.args.getlist('industry') %}
      {% set _sections   = request.args.getlist('section') %}
      {% set _rules      = request.args.getlist('rule') %}
      {% set _parties    = request.args.getlist('party') %}
      {% set _s1s        = request.args.getlist('s1') %}
      {% set _s2s        = request.args.getlist('s2') %}

      {% if search_summary %}
        <div class="crit">Search Criteria</div>
        <div class="box" style="background:#fff">{{ search_summary }}</div>
        <div class="section-divider"></div>
      {% elif _q or _industries or _sections or _rules or _parties or _s1s or _s2s %}
        <div class="crit">Search Criteria</div>
        <div class="box" style="background:#fff">
          {% if _q %}<div><b>Search:</b> {{ _q }}</div>{% endif %}
          {% if _industries %}<div><b>Industry:</b> {{ _industries|join(', ') }}</div>{% endif %}
          {% if _sections %}<div><b>Section:</b> {{ _sections|join(', ') }}</div>{% endif %}
          {% if _rules %}<div><b>Rule:</b> {{ _rules|join(', ') }}</div>{% endif %}
          {% if _parties %}<div><b>Party:</b> {{ _parties|join(', ') }}</div>{% endif %}
          {% if _s1s %}<div><b>Subject 1:</b> {{ _s1s|join(', ') }}</div>{% endif %}
          {% if _s2s %}<div><b>Subject 2:</b> {{ _s2s|join(', ') }}</div>{% endif %}
        </div>
        <div class="section-divider"></div>
      {% endif %}

      {% if list_results or all_results or results %}
        <h4>Results</h4>
        <div class="mini">
          {# Prefer list_results; else, IF q exists (AI search), use results; ELSE fall back to all_results/results #}
          {% set _panel_results = (list_results or (results if _q else (all_results or results)) or []) %}
          {% for it in _panel_results %}
            <div class="item">
              <a class="panel-case" href="{{ url_for('public_case_detail', rid=it.id,
                                                     industry=request.args.getlist('industry'),
                                                     section=request.args.getlist('section'),
                                                     rule=request.args.getlist('rule'),
                                                     party=request.args.getlist('party'),
                                                     s1=request.args.getlist('s1'),
                                                     s2=request.args.getlist('s2'),
                                                     q=request.args.get('q') or request.args.get('ai_q'),
                                                     ai_search=request.args.get('ai_search'),
                                                     ai_q=request.args.get('ai_q') or request.args.get('q'),
                                                     page=request.args.get('page')) }}">
                Case No.: {{ it.case_law_number }}
              </a>
              <div class="row"><b>Party</b><div>{{ it.name_of_party }}</div></div>
              <div class="row"><b>Date</b><div>{{ it.date }}</div></div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </aside>

    <!-- Main -->
    <div>
      <!-- (removed in print) -->
      <div class="print-page-head" aria-hidden="true">
        <span class="pp-case">Case No.: {{ r.case_law_number }}</span> ‚Ä¢ <span class="pp-page"></span>
      </div>
      <div class="sheet print-pad">
        <!-- Controls -->
        <div class="top-row">
          <button type="button" class="back-btn"
                  onclick="if(history.length>1){history.back()}else{location.href='{{ url_for('home') }}'}">‚Üê Back</button>
          <div class="spacer"></div>
          <!-- NEW: AI Summary button (placed before Print) -->
          <button id="aiSummaryBtn" type="button" class="print-btn" title="AI Summary of the Case" onclick="generateAISummary()">
            <svg class="print-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3l1.9 3.9 4.3.6-3.1 3 0.7 4.3L12 13.7 8.2 14.8l0.7-4.3-3.1-3 4.3-.6L12 3z" stroke="#000" stroke-width="1.2"/>
            </svg>
            AI Summary of the Case
          </button>
          <script>
          (function(){
            // Show box only when needed
            var boxEl = document.getElementById('aiSummaryBox');
            if (boxEl) boxEl.style.display = 'none';

            function escapeHtml(s){
              return (s||'').replace(/[&<>"']/g, function(m){
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
              });
            }

            function printAISummary(){
              var content = document.getElementById('aiSummaryContent');
              if (!content || !(content.innerHTML || content.textContent)){
                alert('Nothing to print yet. Generate the AI summary first.');
                return;
              }
              var html = content.innerHTML && content.innerHTML.trim()
                ? content.innerHTML
                : ('<pre>'+escapeHtml(content.textContent || '')+'</pre>');
              var caseNo = {{ r.case_law_number|tojson }};
              var party  = {{ (r.case_name or r.name_of_party)|tojson }};
              var w = window.open('', '_blank');
              if (!w) return;
              w.document.open();
              w.document.write(
                '<!doctype html><html><head><meta charset="utf-8"><title>AI Summary ‚Äî ' + caseNo + '</title>' +
                '<style>' +
                  '.prose, .prose *{font-family:"Aptos","Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif !important; font-size:12pt !important; line-height:1.5 !important; text-align:justify; color:#000;}' +
                  'body{margin:16mm;}' +
                  '.print-head{ text-align:center; margin:0 0 8mm 0; }' +
                  '.print-case{ font-size:14pt; font-weight:700; }' +
                  '.print-party{ font-size:16pt; font-weight:700; margin-top:4mm; }' +
                  '.print-footer{ position:fixed; bottom:8mm; left:0; right:0; text-align:center; font-size:10pt; color:#555; }' +
                  '@media print{ .print-footer{ display:block; } }' +
                '</style>' +
                '</head><body>' +
                  '<div class="print-head">' +
                    '<div class="print-case">AI Summary ‚Äî Case No.: ' + caseNo + '</div>' +
                    '<div class="print-party">' + party + '</div>' +
                  '</div>' +
                  '<div class="prose">' + html + '</div>' +
                  '<div class="print-footer">www.acergst.com</div>' +
                '</body></html>'
              );
              w.document.close();
              w.focus();
              w.print();
            }

            function cleanAISummaryHTML(s){
              if (!s) return '';
              s = String(s).trim();
              // Strip leading/trailing code fences like ```html ‚Ä¶ ```
              s = s.replace(/^```[\w-]*\s*/i, '').replace(/\s*```$/i, '').replace(/```/g, '');
              // Remove any extra model commentary like "This HTML summary ‚Ä¶"
              s = s.replace(/<p[^>]*>\s*This(?:\s+HTML)?\s+summary[\s\S]*?<\/p>\s*/gi, '');
              s = s.replace(/\s*This(?:\s+HTML)?\s+summary[\s\S]*$/i, '');
              // Collapse empty paragraphs
              s = s.replace(/<p>\s*<\/p>/gi, '');
              return s;
            }

            function undoAISummary(){
              var box = document.getElementById('aiSummaryBox');
              var out = document.getElementById('aiSummaryContent');
              var statusEl = document.getElementById('aiStatus');
              if (out) out.innerHTML = '';
              if (statusEl) statusEl.textContent = '';
              if (box) box.style.display = 'none';
              // scroll back to headnotes, if present
              var hn = document.getElementById('section-headnotes');
              if (hn) { try { hn.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e){} }
            }

            function generateAISummary(){
              var btn      = document.getElementById('aiSummaryBtn');
              var box      = document.getElementById('aiSummaryBox');
              var statusEl = document.getElementById('aiStatus');
              var out      = document.getElementById('aiSummaryContent');
              var fullCase = document.getElementById('fullCase');

              var caseName   = {{ (r.case_name or r.name_of_party)|tojson }};
              var caseNumber = {{ r.case_law_number|tojson }};
              var caseText   = '';

              if (fullCase){
                caseText = (fullCase.innerText || fullCase.textContent || '').trim();
              }

              if (!caseText){
                if (box) {
                  box.style.display = 'block';
                  out.textContent = 'Full case text is not available on this page. Please ensure the full case is loaded.';
                }
                return;
              }

              if (box) box.style.display = 'block';
              if (statusEl){ statusEl.textContent = 'Summarising‚Ä¶'; box.setAttribute('aria-busy', 'true'); }
              if (btn){ btn.disabled = true; btn.style.opacity = 0.7; }

              fetch('{{ url_for("generate_ai_summary") if false else "/api/generate_ai_summary" }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  case_text: caseText,
                  case_name: caseName,
                  case_number: caseNumber
                })
              })
              .then(function(res){ return res.json(); })
              .then(function(data){
                if (data && data.error){
                  out.textContent = 'Error: ' + (data.error || 'Unable to generate summary.');
                  return;
                }
                if (data && (data.summary_html || data.html)){
                  var html = cleanAISummaryHTML(data.summary_html || data.html);
                  out.innerHTML = html;
                  return;
                }
                var txt = (data && (data.summary || data.content || data.result)) || 'No summary received.';
                out.textContent = txt;
              })
              .catch(function(err){
                out.textContent = 'Error: ' + (err && err.message ? err.message : 'Unexpected failure.');
              })
              .finally(function(){
                if (statusEl){ statusEl.textContent = ''; box.setAttribute('aria-busy', 'false'); }
                if (btn){ btn.disabled = false; btn.style.opacity = 1; }
                try { box.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e){}
              });
            }

            // Make them available to inline onclick too
            window.generateAISummary = generateAISummary;
            window.printAISummary    = printAISummary;
            window.undoAISummary     = undoAISummary;

            // Also wire the click via JS
            document.addEventListener('DOMContentLoaded', function(){
              var b = document.getElementById('aiSummaryBtn');
              if (b && !b.dataset._aiBound) {
                b.addEventListener('click', window.generateAISummary);
                b.dataset._aiBound = '1';
              }
            });
          })();
          </script>

          <button class="print-btn" id="printBtn" title="Print"
              onclick="document.getElementById('printChoiceModal').style.display='flex'; return false;">
              <svg class="print-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9V3h12v6M6 14H5a 2 2 0 0 1-2-2v-1a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1" stroke="#000" stroke-width="1.5"/>
                  <path d="M7 14h10v7H7z" stroke="#000" stroke-width="1.5"/>
              </svg>
              Print
          </button>
        </div>

        <div id="printChoiceModal" class="print-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="printChoiceTitle">
            <div class="print-modal">
              <h4 id="printChoiceTitle">Print options</h4>
              <p style="font-size: 11px; color:#666; margin: 0 0 8px 0;">Tip:  Uncheck "Headers and footers" in your browser's print dialog to remove the date/URL from printouts.</p>
              <label class="choice">
                <input type="radio" name="printChoice" id="printChoiceHead" value="head" checked>
                <span>Head Notes only</span>
              </label>
              <label class="choice">
                <input type="radio" name="printChoice" id="printChoiceFull" value="full">
                <span>Full Case Law</span>
              </label>
                <div class="actions">
                  <button type="button" class="print-btn" id="printCancelBtn" onclick="document.getElementById('printChoiceModal').style.display='none'; return false;">Cancel</button>
                  <button type="button" class="print-btn" id="printOkBtn" onclick="(function(){ var h=document.getElementById('printChoiceHead'); document.body.classList.toggle('print-headnotes-only', h && h.checked); document.getElementById('printChoiceModal').style.display='none'; setTimeout(function(){window.print();},30); })(); return false;">OK</button>
                </div>
            </div>
          </div>

        <!-- Hero -->
        <div class="hero-case">
          <div class="case-no">Case No.: <strong>{{ r.case_law_number }}</strong></div>
          <div class="party-name">{{ r.case_name or r.name_of_party }}</div>
          <div class="meta">
            {% set _d = r.date|string %}
            <span class="pill"><span class="dot"></span>
              {% if _d and _d|length >= 10 and '-' in _d %}
                {{ _d[8:10] ~ '-' ~ _d[5:7] ~ '-' ~ _d[0:4] }}
              {% else %}{{ r.date }}{% endif %}
            </span>
            {% if r.type_of_court %}<span class="pill"><span class="dot"></span>{{ r.type_of_court }}</span>{% endif %}
            {% if r.state %}<span class="pill"><span class="dot"></span>{{ r.state }}</span>{% endif %}
            {% if r.subject_matter1 %}<span class="pill"><span class="dot"></span>{{ r.subject_matter1 }}</span>{% endif %}
            {% if r.subject_matter2 %}<span class="pill"><span class="dot"></span>{{ r.subject_matter2 }}</span>{% endif %}
            {% if r.rule %}<span class="pill"><span class="dot"></span>Rule: {{ r.rule }}</span>{% endif %}
          </div>
        </div>

        <!-- Summary / Headnotes -->
        <div class="box" id="section-headnotes">
          <h3 class="section">Summary / Headnotes</h3>
          <div class="prose headnotes js-hl-scope" id="hnContainer">
            {{ (r.get('summary_head_note') or r.get('summary_full') or r.get('Head Notes')) | safe }}
          </div>
        </div>

        <!-- NEW: AI Summary box (hidden until button clicked) -->
        <div class="box" id="aiSummaryBox" aria-live="polite" aria-busy="false">
          <h3 class="section">AI Summary of the Case</h3>
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
            <button type="button" class="print-btn" id="aiPrintBtn" onclick="printAISummary()" title="Print AI Summary">üñ®Ô∏è Print Summary</button>
            <!-- NEW: Undo button -->
            <button type="button" class="print-btn" id="aiUndoBtn" onclick="undoAISummary()" title="Undo AI Summary">‚Ü© Undo Summary</button>
            <span id="aiStatus" style="font-size:12px;color:#444;"></span>
          </div>
          <div class="prose" id="aiSummaryContent"></div>
        </div>

        <div class="section-divider"></div>

        <!-- Question Answered -->
        {% if r.question_answered %}
        <div class="box" id="section-qa">
          <h3 class="section">Question Answered</h3>
          <div class="prose js-hl-scope">{{ r.question_answered|safe }}</div>
        </div>
        <div class="section-divider"></div>
        {% endif %}

        <!-- Citations -->
        {% if citations_text %}
        <div class="box" id="section-citations">
          <h3 class="section">Citations</h3>
          {% set _cits = citations_text | replace(';','
') | replace(',', '
') | replace('<br>','
') | replace('<br/>','
') | replace('<br />','
') %}
          {% set _list = _cits.splitlines() %}
          <div class="prose">
            <ul id="citList" style="margin:0;padding-left:18px">
              {% for c in _list if c.strip() %}
                <li>{{ c.strip()|safe }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="section-divider"></div>
        {% endif %}

        <!-- Full Case Law -->
        {% if full_case_html %}
        <div id="section-fullcase">
          <div class="prose fullcase js-hl-scope" id="fullCase">{{ full_case_html|safe }}</div>
          <div class="print-endcase" style="display:none;">
            <hr><div class="case">Case No.: {{ r.case_law_number }}</div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  // FULL CASE: minor <br> collapse on screen only (leave print intact)
  (function(){
    var el = document.getElementById('fullCase');
    if (!el) return;
    if (window.matchMedia && window.matchMedia('print').matches) return;
    el.innerHTML = el.innerHTML.replace(/(?:<br\s*\/?>\s*){3,}/gi, '<br>');
  })();

  // CITATIONS: linkify AGST case numbers
  (function(){
    var ul = document.getElementById('citList');
    if(!ul) return;
    var re = /\b\d{4}-AGST-\d+(?:-[A-Z]+(?:\([A-Z]{1,3}\))?)?\b/g;
    Array.from(ul.querySelectorAll('li')).forEach(function(li){
      if (li.querySelector('a')) return;
      var html = li.innerHTML;
      var replaced = html.replace(re, function(m){
        var href = "{{ url_for('home') }}" + "?q=" + encodeURIComponent(m);
        return '<a href="'+href+'" title="Open ' + m + '">'+m+'</a>';
      });
      if (replaced !== html) li.innerHTML = replaced;
    });
  })();

  // Highlight search phrase in detail view
  (function(){
    const params = new URLSearchParams(location.search);
    const q = (params.get('q') || '').trim();
    if (!q) return;
    const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const re = new RegExp('(' + esc + ')', 'gi');
    function walk(node){
      if (node.nodeType === 3){
        const txt = node.nodeValue;
        if (!txt.trim()) return;
        const replaced = txt.replace(re, '<span class="hl">$1</span>');
        if (replaced !== txt){
          const span = document.createElement('span');
          span.innerHTML = replaced;
          node.parentNode.replaceChild(span, node);
        }
        return;
      }
      Array.from(node.childNodes).forEach(walk);
    }
    document.querySelectorAll('.js-hl-scope').forEach(function(scope){
      Array.from(scope.childNodes).forEach(walk);
    });
  })();

  // ===== AI SUMMARY: fetch summary and show box =====
  (function initAISummaryBox(){
    var box = document.getElementById('aiSummaryBox');
    if (box) { box.style.display = 'none'; } // keep hidden until invoked
  })();

  function generateAISummary(){
    var btn = document.getElementById('aiSummaryBtn');
    var box = document.getElementById('aiSummaryBox');
    var statusEl = document.getElementById('aiStatus');
    var out = document.getElementById('aiSummaryContent');
    var fullCaseEl = document.getElementById('fullCase');

    // Gather inputs
    var caseName = {{ (r.case_name or r.name_of_party)|tojson }};
    var caseNumber = {{ r.case_law_number|tojson }};
    var caseText = '';
    if (fullCaseEl){
      // Use visible full case law (already loaded on page)
      caseText = fullCaseEl.innerText || fullCaseEl.textContent || '';
      caseText = caseText.trim();
    }

    if (!caseText){
      // If the full case is not present on the page, show a helpful message
      var msg = 'Full case text is not available on this page. Please ensure the full case is loaded.';
      if (box) {
        box.style.display = 'block';
        out.textContent = msg;
      }
      return;
    }

    // UI: show box, set busy state
    if (box) box.style.display = 'block';
    if (statusEl){ statusEl.textContent = 'Summarising‚Ä¶'; box.setAttribute('aria-busy', 'true'); }
    if (btn){ btn.disabled = true; btn.style.opacity = 0.7; }

    // Call server route expected to create structured summary
    fetch('{{ url_for("generate_ai_summary") if false else "/api/generate_ai_summary" }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        case_text: caseText,
        case_name: caseName,
        case_number: caseNumber
      })
    })
    .then(function(res){ return res.json(); })
    .then(function(data){
      // Accept a few common payload shapes
      var txt = '';
      if (data && data.error){
        txt = 'Error: ' + (data.error || 'Unable to generate summary.');
      } else if (data && (data.summary_html || data.html)){
        txt = data.summary_html || data.html;
        // trust server HTML minimally (if provided)
        // clean trailing commentary and fences
        txt = txt ? txt.toString() : '';
        txt = txt.replace(/^```[\w-]*\s*/i, '').replace(/\s*```$/i, '').replace(/```/g, '');
        txt = txt.replace(/<p[^>]*>\s*This(?:\s+HTML)?\s+summary[\s\S]*?<\/p>\s*/gi, '');
        txt = txt.replace(/\s*This(?:\s+HTML)?\s+summary[\s\S]*$/i, '');
        out.innerHTML = txt;
        return;
      } else if (data && (data.summary || data.content || data.result)){
        txt = data.summary || data.content || data.result;
      } else {
        txt = 'No summary received.';
      }

      // Default: render as text
      out.textContent = txt;
    })
    .catch(function(err){
      out.textContent = 'Error: ' + (err && err.message ? err.message : 'Unexpected failure.');
    })
    .finally(function(){
      if (statusEl){ statusEl.textContent = ''; box.setAttribute('aria-busy', 'false'); }
      if (btn){ btn.disabled = false; btn.style.opacity = 1; }
      // Scroll the box into view
      try { box.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e){}
    });
  }

  function printAISummary(){
    var content = document.getElementById('aiSummaryContent');
    if (!content || !(content.innerHTML || content.textContent)){
      alert('Nothing to print yet. Generate the AI summary first.');
      return;
    }
    var html  = content.innerHTML && content.innerHTML.trim()
      ? content.innerHTML
      : ('<pre>'+escapeHtml(content.textContent || '')+'</pre>');

    var caseNo = {{ r.case_law_number|tojson }};
    var party  = {{ (r.case_name or r.name_of_party)|tojson }};

    var w = window.open('', '_blank'); if (!w) return;
    w.document.open();
    w.document.write(
      '<!doctype html><html><head><meta charset="utf-8">' +
      '<title>AI Summary ‚Äî ' + caseNo + '</title>' +
      '<style>' +
        '.prose, .prose *{font-family:"Aptos","Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif !important;' +
        ' font-size:12pt !important; line-height:1.5 !important; text-align:justify; color:#000;}' +
        'body{margin:16mm;}' +
        '.print-head{ text-align:center; margin:0 0 8mm 0; }' +
        '.print-case{ font-size:14pt; font-weight:700; }' +
        '.print-party{ font-size:16pt; font-weight:700; margin-top:4mm; }' +
        '.print-footer{ position:fixed; bottom:8mm; left:0; right:0; text-align:center; font-size:10pt; color:#555; }' +
        '@media print{ .print-footer{ display:block; } }' +
      '</style>' +
      '</head><body>' +
        '<div class="print-head">' +
          '<div class="print-case">AI Summary ‚Äî Case No.: ' + caseNo + '</div>' +
          '<div class="print-party">' + party + '</div>' +
        '</div>' +
        '<div class="prose">' + html + '</div>' +
        '<div class="print-footer">www.acergst.com</div>' +
      '</body></html>'
    );
    w.document.close();
    w.focus();
    w.print();
  }

  function undoAISummary(){
    var box = document.getElementById('aiSummaryBox');
    var out = document.getElementById('aiSummaryContent');
    var statusEl = document.getElementById('aiStatus');
    if (out) out.innerHTML = '';
    if (statusEl) statusEl.textContent = '';
    if (box) box.style.display = 'none';
    var hn = document.getElementById('section-headnotes');
    if (hn) { try { hn.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e){} }
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }
  // Expose to inline handlers (guards prevent double-define)
  if (typeof window.generateAISummary !== 'function') window.generateAISummary = generateAISummary;
  if (typeof window.printAISummary    !== 'function') window.printAISummary    = printAISummary;
  if (typeof window.undoAISummary     !== 'function') window.undoAISummary     = undoAISummary;

  // Safety: also attach the click via JS (in case inline onclick is ignored)
  document.addEventListener('DOMContentLoaded', function(){
    var b = document.getElementById('aiSummaryBtn');
    if (b && !b.dataset._aiBound) {
      b.addEventListener('click', window.generateAISummary);
      b.dataset._aiBound = '1';
    }
  });

  // === Print choice modal (global) ===
  function openPrintChooser(){
    const m = document.getElementById('printChoiceModal');
    if (m) m.style.display = 'flex';
    const head = document.getElementById('printChoiceHead');
    if (head) head.checked = true; // default
    document.body.classList.remove('print-headnotes-only');
  }
  function closePrintChooser(){
    const m = document.getElementById('printChoiceModal');
    if (m) m.style.display = 'none';
  }
  function confirmPrintChoice(){
    const head = document.getElementById('printChoiceHead');
    const isHeadOnly = head && head.checked;
    document.body.classList.toggle('print-headnotes-only', !!isHeadOnly);
    closePrintChooser();
    setTimeout(() => window.print(), 30);
  }
  window.openPrintChooser = openPrintChooser;
  window.closePrintChooser = closePrintChooser;
  window.confirmPrintChoice = confirmPrintChoice;

  // Bind the print button and modal buttons explicitly
  (function(){
      function bindPrintButtons(){
          var pb = document.getElementById('printBtn');
          if (pb && !pb.dataset._printBound) {
              pb.removeAttribute('onclick');
              pb.addEventListener('click', function(e){
                  e.preventDefault();
                  e.stopPropagation();
                  openPrintChooser();
              });
              pb.dataset._printBound = '1';
          }

          var cancelBtn = document.getElementById('printCancelBtn');
          if (cancelBtn && !cancelBtn.dataset._printBound) {
              cancelBtn.addEventListener('click', function(e){
                  e.preventDefault();
                  e.stopPropagation();
                  closePrintChooser();
              });
              cancelBtn.dataset._printBound = '1';
          }

          var okBtn = document.getElementById('printOkBtn');
          if (okBtn && !okBtn.dataset._printBound) {
              okBtn.addEventListener('click', function(e){
                  e.preventDefault();
                  e.stopPropagation();
                  confirmPrintChoice();
              });
              okBtn. dataset._printBound = '1';
          }
      }

      // Run immediately if DOM already loaded, otherwise wait
      if (document. readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', bindPrintButtons);
      } else {
          bindPrintButtons();
      }
  })();

  // close modal on Escape
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') closePrintChooser();
  });
</script>
{% endblock %}
