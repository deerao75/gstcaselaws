{% extends "base.html" %}
{% block title %}Case — {{ r.case_name or r.name_of_party }}{% endblock %}
{% block head %}
<style>
  :root{ --sheet-bg:#fff; --sheet-bd:#eaeaea; --soft:0 10px 28px rgba(0,0,0,.08); --orange:#ff7a00; }
  .page-wrap{ display:grid; grid-template-columns: 1fr; gap:16px; align-items:start; }
  .has-panel .page-wrap{ grid-template-columns: 320px minmax(0,1fr); }
  .side-panel{
    display:none; border:1px solid #eee; border-radius:14px; background:#fff;
    box-shadow: var(--soft); padding:12px; position:sticky; top:14px;
    max-height: calc(100dvh - 28px); overflow:auto;
    font-size:13px;
  }
  .side-panel .crit{ font-weight:700; margin:0 0 6px 0; color:#111; border-bottom:1px solid #eee; padding:0 0 6px 0; }
  .side-panel h4{ margin:0 0 6px 0; font-size:16px; font-weight:700; color:#111; }
  .side-panel .mini{ display:flex; flex-direction:column; gap:8px; }
  .side-panel .mini .item{ border:1px solid #eee; border-radius:10px; padding:10px; background:#fafafa; }
  .side-panel .mini .item .row{
    display:grid; grid-template-columns: 70px 1fr; gap:6px; font-size:12px; margin:2px 0; align-items:start; line-height:1.3;
  }
  .side-panel .mini .item .row b{ color:#444; font-weight:600; }
  .panel-case{ display:inline-block; font-weight:600; color:var(--orange); text-decoration:none; margin-bottom:4px; font-size:12px; }
  .panel-case:hover{ text-decoration:underline; }
  .sheet{background:var(--sheet-bg);border:1px solid var(--sheet-bd);box-shadow:var(--soft);border-radius:16px;padding:20px}
  .top-row{display:flex;align-items:center;gap:10px;margin-bottom:10px; position:relative; z-index:5;}
  .spacer{flex:1}
  .print-btn,.back-btn{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid #dadada;background:#fff;cursor:pointer;font-weight:700;
    box-shadow:0 4px 10px rgba(0,0,0,.06);transition:transform .06s ease, box-shadow .12s ease, background .12s ease
  }
  .print-btn:hover,.back-btn:hover{background:#f7f7f7;box-shadow:0 6px 16px rgba(0,0,0,.1)}
  .print-btn:active,.back-btn:active{transform:translateY(1px)}
  .print-icon{width:20px;height:20px}
  .hero-case{border:1px solid #efefef;border-radius:14px;padding:16px;margin-bottom:12px;background:linear-gradient(180deg,#fff 0%,#fafafa 100%)}
  .case-no{font-weight:800;color:#111}
  .case-no strong{color:var(--orange)}
  .party-name{font-weight:800;font-size:28px;line-height:1.15;margin-top:6px;background:linear-gradient(92deg,#111 0%,#333 45%,#111 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
  .meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;align-items:center;color:#222;font-weight:700}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f6f6f6;border:1px solid #ececec;font-size:12px;color:#111}
  .pill .dot{width:6px;height:6px;border-radius:50%;background:var(--orange);display:inline-block}
  h3.section{margin:14px 0 8px 0;font-size:18px;font-weight:900;color:#111}
  .box{background:#f9fafb;border:1px solid #ededed;border-radius:14px;padding:16px;margin-bottom:12px}
  .pad-left{padding-left:14px}
  .section-divider{height:1px;background:#000;margin:12px 0}
  .prose,.prose *{ font-family:"Aptos","Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif !important; font-size:11pt !important; line-height:1.5 !important; color:#111 !important; text-align:justify; }
  .prose img{max-width:100%;height:auto}
  .prose table{border-collapse:collapse;margin:8px auto}
  .prose table td,.prose table th{border:1px solid #ddd;padding:6px}
  .fullcase.prose{white-space:normal !important; max-height:60vh; overflow:auto;}
  .fullcase.prose p,.fullcase.prose li,.fullcase.prose h1,.fullcase.prose h2,.fullcase.prose h3,.fullcase.prose h4,.fullcase.prose h5,.fullcase.prose h6,.fullcase.prose div{margin:6pt 0 !important}
  .fullcase.prose *:empty{display:none}
  .fullcase.prose br+br{display:none}
  .fullcase.prose p:has(br){margin:6pt 0 !important}

  /* PRINT */
  .print-first-header{ display:none; }
  @page {
    margin: 20mm 16mm 30mm 12mm;
    @top-right {
      content: url("{{ brand_logo_url or url_for('static', filename='images/acer_logo.png') }}");
      height: 5px;
      width: auto;
      margin-top: 5px;
      opacity: 0.8;
    }
    @bottom-center {
      content: "www.acergst.com | Page " counter(page);
      font-family: sans-serif;
      font-size: 10px;
      color: #555;
      white-space: nowrap;
    }
  }
  @media print{
    *{ -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; box-shadow:none !important; }
    body, .sheet, .box, .hero-case, .pill, .prose table, .side-panel, .top-row, .print-btn, .back-btn{ background:transparent !important; }
    .hero-case, .box, .sheet{ border-color:#ccc !important; border-radius:0 !important; }
    .party-name{
      background:none !important;
      color:#000 !important;
      -webkit-background-clip:initial !important;
      background-clip:initial !important;
      font-weight:600 !important;
      font-size:22px !important;
      text-align:center !important;
      margin:8px 0 !important;
    }
    .case-no{
      font-weight:600 !important;
      color:#000 !important;
      text-align:center !important;
      margin:0 auto;
      display:block;
      width: fit-content;
      padding:0;
    }
    .case-no strong{ color:#000 !important; }
    .hero-case {
      text-align: center;
      padding:12px !important;
    }
    .pill{ border-color:#ccc !important; }
    .pill .dot{ background:#000 !important; }
    .section-divider{ background:#000 !important; }
    .print-page-head{ display:none !important; }
    .topbar,.footer,.back-btn,.print-chooser,.top-row,#printBtn,.side-panel{display:none !important}
    .sheet{border:0; padding:0}
    .print-brand{ display:none !important; }

    /* Remove Full Case Law heading and avoid forced page break */
    #section-fullcase { page-break-before: avoid; }
    #section-fullcase > h3.section { display: none; }

    /* Ensure full case flows naturally */
    .fullcase.prose, #fullCase{ max-height:none !important; overflow:visible !important; }

    /* Avoid splitting tables */
    .prose table, .box table { break-inside: avoid; page-break-inside: avoid; }
    .prose tr, .prose td, .prose th, .box tr, .box td, .box th { break-inside: avoid; page-break-inside: avoid; }

    /* Watermark = Case No., one line, small */
    body::before{
      content:"{{ r.case_law_number }}";
      position:fixed;
      top:55%; left:50%;
      transform:translate(-50%,-50%) rotate(-25deg);
      font-size:32pt;
      font-weight:800;
      color:#000;
      opacity:.05;
      z-index:-1;
      pointer-events:none;
      white-space:nowrap;
      line-height:1;
    }

    /* End-of-case line + case number (print only) */
    .print-endcase{ display:block !important; margin:4mm 0 0 0; text-align:center; }
    .print-endcase hr{ border:none; border-top:1px solid #000; margin:0 0 2mm 0; }
    .print-endcase .case{ font-size:11px; }

    /* Center the meta data (pills) */
    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 8px;
      color: #222;
      font-weight: 600;
      font-size: 11px;
    }
    .pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 8px;
    }
    .pill .dot {
      width: 5px;
      height: 5px;
    }
  }
  @media (max-width: 1100px){
    .has-panel .page-wrap{ grid-template-columns: 1fr; }
    .side-panel{ position:static; max-height:none; }
  }
  .print-brand { display: none; }
  @media print {
    .print-brand {
      display: none !important;
    }

  }
  /* highlight in detail view */
  .hl{ background:var(--orange-faint); border-radius:3px; padding:0 2px; }
</style>
{% endblock %}
{% block content %}
<div class="container {% if search_summary or list_results or all_results or results %}has-panel{% endif %}">
  <div class="page-wrap">
    <!-- Left Panel -->
    <aside class="side-panel" {% if search_summary or list_results or all_results or results %}style="display:block"{% endif %}>
      {% if search_summary %}
        <div class="crit">Search Criteria</div>
        <div class="box" style="background:#fff">{{ search_summary }}</div>
        <div class="section-divider"></div>
      {% endif %}
      {% if list_results or all_results or results %}
        <h4>Results</h4>
        <div class="mini">
          {% set _panel_results = list_results or all_results or results or [] %}
          {% for it in _panel_results %}
            <div class="item">
              <a class="panel-case" href="{{ url_for('public_case_detail', rid=it.id,
                                                     industry=request.args.getlist('industry'),
                                                     section=request.args.getlist('section'),
                                                     rule=request.args.getlist('rule'),
                                                     party=request.args.getlist('party'),
                                                     s1=request.args.getlist('s1'),
                                                     s2=request.args.getlist('s2'),
                                                     q=request.args.get('q'),
                                                     page=request.args.get('page')) }}">
                Case No.: {{ it.case_law_number }}
              </a>
              <div class="row"><b>Party</b><div>{{ it.name_of_party }}</div></div>
              <div class="row"><b>Date</b><div>{{ it.date }}</div></div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </aside>
    <!-- Main -->
    <div>
      <!-- (removed in print) -->
      <div class="print-page-head" aria-hidden="true">
        <span class="pp-case">Case No.: {{ r.case_law_number }}</span> • <span class="pp-page"></span>
      </div>
      <div class="sheet print-pad">
        <!-- Controls -->
        <div class="top-row">
          <button type="button" class="back-btn"
                  onclick="if(history.length>1){history.back()}else{location.href='{{ url_for('home') }}'}">← Back</button>
          <div class="spacer"></div>
          <button class="print-btn" title="Print" onclick="window.print()">
            <svg class="print-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 9V3h12v6M6 14H5a 2 2 0 0 1-2-2v-1a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1" stroke="#000" stroke-width="1.5"/>
              <path d="M7 14h10v7H7z" stroke="#000" stroke-width="1.5"/>
            </svg>
            Print
          </button>
        </div>
        <!-- Hero -->
        <div class="hero-case">
          <div class="case-no">Case No.: <strong>{{ r.case_law_number }}</strong></div>
          <div class="party-name">{{ r.case_name or r.name_of_party }}</div>
          <div class="meta">
            {% set _d = r.date|string %}
            <span class="pill"><span class="dot"></span>
              {% if _d and _d|length >= 10 and '-' in _d %}
                {{ _d[8:10] ~ '-' ~ _d[5:7] ~ '-' ~ _d[0:4] }}
              {% else %}{{ r.date }}{% endif %}
            </span>
            {% if r.type_of_court %}<span class="pill"><span class="dot"></span>{{ r.type_of_court }}</span>{% endif %}
            {% if r.state %}<span class="pill"><span class="dot"></span>{{ r.state }}</span>{% endif %}
            {% if r.subject_matter1 %}<span class="pill"><span class="dot"></span>{{ r.subject_matter1 }}</span>{% endif %}
            {% if r.subject_matter2 %}<span class="pill"><span class="dot"></span>{{ r.subject_matter2 }}</span>{% endif %}
            {% if r.rule %}<span class="pill"><span class="dot"></span>Rule: {{ r.rule }}</span>{% endif %}
          </div>
        </div>
        <!-- Summary / Headnotes -->
        <div class="box" id="section-headnotes">
          <h3 class="section">Summary / Headnotes</h3>
          <div class="prose headnotes js-hl-scope" id="hnContainer">
            {{ (r.get('summary_head_note') or r.get('summary_full') or r.get('Head Notes')) | safe }}
          </div>
        </div>
        <div class="section-divider"></div>
        <!-- Question Answered -->
        {% if r.question_answered %}
        <div class="box" id="section-qa">
          <h3 class="section">Question Answered</h3>
          <div class="prose js-hl-scope">{{ r.question_answered|safe }}</div>
        </div>
        <div class="section-divider"></div>
        {% endif %}
        <!-- Citations -->
        {% if citations_text %}
        <div class="box" id="section-citations">
          <h3 class="section">Citations</h3>
          {% set _cits = citations_text | replace(';','
') | replace(',', '
') | replace('<br>','
') | replace('<br/>','
') | replace('<br />','
') %}
          {% set _list = _cits.splitlines() %}
          <div class="prose">
            <ul id="citList" style="margin:0;padding-left:18px">
              {% for c in _list if c.strip() %}
                <li>{{ c.strip()|safe }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="section-divider"></div>
        {% endif %}
        <!-- Full Case Law -->
        {% if full_case_html %}
        <div id="section-fullcase">
          <!-- h3.section pad-left removed per requirement -->
          <div class="prose fullcase js-hl-scope" id="fullCase">{{ full_case_html|safe }}</div>
          <div class="print-endcase" style="display:none;">
            <hr><div class="case">Case No.: {{ r.case_law_number }}</div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  // FULL CASE: minor <br> collapse on screen only (leave print intact)
  (function(){
    var el = document.getElementById('fullCase');
    if (!el) return;
    if (window.matchMedia && window.matchMedia('print').matches) return;
    el.innerHTML = el.innerHTML.replace(/(?:<br\s*\/?>\s*){3,}/gi, '<br>');
  })();
  // CITATIONS: linkify AGST case numbers
  (function(){
    var ul = document.getElementById('citList');
    if(!ul) return;
    var re = /\b\d{4}-AGST-\d+(?:-[A-Z]+(?:\([A-Z]{1,3}\))?)?\b/g;
    Array.from(ul.querySelectorAll('li')).forEach(function(li){
      if (li.querySelector('a')) return;
      var html = li.innerHTML;
      var replaced = html.replace(re, function(m){
        var href = "{{ url_for('home') }}" + "?q=" + encodeURIComponent(m);
        return '<a href="'+href+'" title="Open ' + m + '">'+m+'</a>';
      });
      if (replaced !== html) li.innerHTML = replaced;
    });
  })();
  // Highlight search phrase in detail view
  (function(){
    const params = new URLSearchParams(location.search);
    const q = (params.get('q') || '').trim();
    if (!q) return;
    const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const re = new RegExp('(' + esc + ')', 'gi');
    function walk(node){
      if (node.nodeType === 3){
        const txt = node.nodeValue;
        if (!txt.trim()) return;
        const replaced = txt.replace(re, '<span class="hl">$1</span>');
        if (replaced !== txt){
          const span = document.createElement('span');
          span.innerHTML = replaced;
          node.parentNode.replaceChild(span, node);
        }
        return;
      }
      Array.from(node.childNodes).forEach(walk);
    }
    document.querySelectorAll('.js-hl-scope').forEach(function(scope){
      Array.from(scope.childNodes).forEach(walk);
    });
  })();
</script>
{% endblock %}
