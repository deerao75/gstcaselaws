{% extends "base.html" %}
{% block title %}Admin ‚Äî {{ table_name or 'Case Laws' }}{% endblock %}
{% block content %}
<style>
:root{ --content-width: 1100px; }
.admin-wrap{
  max-width: var(--content-width); margin: 18px auto; padding: 0 16px;
  display: grid; grid-template-columns: 220px 1fr; gap: 16px; align-items: start;
}
.side{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
.side h3{ margin:6px 0 10px; font-size:15px; }
.nav-btn, .nav-link{
  width:100%; text-align:left; padding:10px 12px; border-radius:8px; border:1px solid #e5e7eb;
  margin-bottom:6px; display:block; color:#111; background:#fff; text-decoration:none;
}
.nav-btn:hover, .nav-link:hover{ background:#f5f5f5; }
.nav-link.active{ border-color:#000; background:#f0f0f0; font-weight:500; }
.main{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
.panel{ display:none; }
.panel.show{ display:block; }
.form-group{ margin-bottom:12px; }
.form-group label{ display:block; margin-bottom:4px; font-size:14px; font-weight:500; }
.form-input, .form-text{
  width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:6px;
  font-size:14px; box-sizing:border-box;
}
.form-text{ height:120px; resize:vertical; }
.form-grid{
  display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;
}
.btn{
  padding:8px 12px; border:none; background:#f0f0f0; border-radius:6px;
  font-size:14px; cursor:pointer;
}
.btn:hover{ background:#e0e0e0; }
.btn-orange{
  background:#f97316; color:#fff;
}
.btn-orange:hover{ background:#ea580c; }
.btn-danger{ background:#ef4444; color:#fff; }
.btn-danger:hover{ background:#dc2626; }
.btn-ghost{ background:transparent; border:1px solid #ddd; }
table{ width:100%; border-collapse:collapse; font-size:14px; }
table th, table td{ padding:10px; text-align:left; border-bottom:1px solid #eee; }
table th{ font-weight:500; background:#fafafa; }
.col-id{ width:60px; }
.col-no{ width:140px; }
.col-date{ width:100px; }
.col-act{ width:160px; }
.nowrap{ white-space:nowrap; }
.muted{ color:#666; text-align:center; padding:20px 0; }
.pill{ background:#e0e0e0; padding:4px 10px; border-radius:12px; font-size:12px; }
.sheet-toolbar{ margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap; }
.rich-wrap{ border:1px solid #ddd; border-radius:6px; overflow:hidden; }
.stats-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background-color: #f9fafb;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.stats-table th, .stats-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}
.stats-table th {
  background-color: #f3f4f6;
  font-weight: 600;
  color: #374151;
}
.stats-table tr:last-child td {
  border-bottom: none;
}
.stats-table .count-cell {
  text-align: right;
  font-weight: 500;
}
.search-row {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
.search-row input[type="text"] {
  flex: 1;
  min-width: 200px;
}
.search-row .btn {
  flex-shrink: 0;
}
.search-row > * {
  margin: 5px 0;
}
</style>
<section class="admin-wrap">
  <!-- LEFT MENU -->
  <aside class="side">
    <h3>Manage Case Laws</h3>
    <!-- Removed Add New button as requested -->
    <a class="nav-link {% if mode=='edit' %}active{% endif %}" href="{{ url_for('admin_caselaws') }}?mode=edit">‚úèÔ∏è Edit</a>
    <a class="nav-link {% if mode=='delete' %}active{% endif %}" href="{{ url_for('admin_caselaws') }}?mode=delete">üóëÔ∏è Delete</a>
    <a class="nav-link" id="bulkDownloadLink" href="{{ url_for('admin_export_csv') }}">‚¨áÔ∏è Bulk Download</a>
    <a class="nav-link" id="bulkUploadLink" href="javascript:void(0)" onclick="document.getElementById('panel-bulkupload').classList.add('show'); document.querySelectorAll('.panel').forEach(p => p !== document.getElementById('panel-bulkupload') && p.classList.remove('show'));">‚¨ÜÔ∏è Bulk Upload</a>
  </aside>
  <!-- RIGHT CONTENT -->
  <div class="main">
    <!-- ADD NEW PANEL REMOVED -->
    <!-- EDIT -->
    {% if edit_item %}
    <div id="panel-edit" class="panel show"><div class="card">
      <h2 style="margin:0 0 8px 0;">Edit Case Law #{{ edit_item.id }}</h2>
      <div class="box">
        <form method="post" action="{{ url_for('admin_edit_case', rid=edit_item.id) }}">
          <div class="form-grid">
            <div class="form-group">
              <label>Case Law Number</label>
              <input class="form-input" type="text" name="case_law_number" value="{{ edit_item.case_law_number }}">
            </div>
            <div class="form-group">
              <label>Name of the Party</label>
              <input class="form-input" type="text" name="name_of_party" value="{{ edit_item.name_of_party }}">
            </div>
            <div class="form-group">
              <label>Date</label>
              <input class="form-input" type="date" name="date" value="{{ edit_item.date }}">
            </div>
            <div class="form-group">
              <label>State</label>
              <input class="form-input" type="text" name="state" value="{{ edit_item.state }}">
            </div>
            <div class="form-group">
              <label>Year</label>
              <input class="form-input" type="number" name="year" value="{{ edit_item.year }}">
            </div>
            <div class="form-group">
              <label>Type of Court</label>
              <input class="form-input" type="text" name="type_of_court" value="{{ edit_item.type_of_court }}">
            </div>
            <div class="form-group">
              <label>Industry</label>
              <input class="form-input" type="text" name="industry_sector" value="{{ edit_item.industry_sector }}">
            </div>
            <div class="form-group">
              <label>Section</label>
              <input class="form-input" type="text" name="section" value="{{ edit_item.section }}">
            </div>
            <div class="form-group">
              <label>Rules</label>
              <input class="form-input" type="text" name="rule" value="{{ edit_item.rule }}">
            </div>
            <div class="form-group">
              <label>Subject Matter 1</label>
              <input class="form-input" type="text" name="subject_matter1" value="{{ edit_item.subject_matter1 }}">
            </div>
            <div class="form-group">
              <label>Subject Matter 2</label>
              <input class="form-input" type="text" name="subject_matter2" value="{{ edit_item.subject_matter2 }}">
            </div>
            <div class="form-group">
              <label>Case Name</label>
              <input class="form-input" type="text" name="case_name" value="{{ edit_item.case_name }}">
            </div>
            <div class="form-group">
              <label>Citations</label>
              <input class="form-input" type="text" name="citation" value="{{ edit_item.citation }}">
            </div>
            <div class="form-group">
              <label>Basic Details</label>
              <input class="form-input" type="text" name="basic_detail" value="{{ edit_item.basic_detail }}">
            </div>
          </div>
          <div class="form-group">
            <label>Head Notes</label>
            <div class="rich-wrap">
              <textarea name="summary_head_note" class="form-text">{{ edit_item.summary_head_note|safe }}</textarea>
            </div>
          </div>
          <div class="form-group">
            <label>Question Answered</label>
            <div class="rich-wrap">
              <textarea name="question_answered" class="form-text">{{ edit_item.question_answered|safe }}</textarea>
            </div>
          </div>
          <div class="form-group">
            <label>Full Case Law</label>
            <div class="rich-wrap">
              <textarea name="full_case_law" class="form-text">{{ edit_item.full_case_law|safe }}</textarea>
            </div>
          </div>
          <div class="form-group">
            <label>Link to Full Case Law</label>
            <input class="form-input" type="url" name="link" value="{{ edit_item.link }}">
          </div>
          <div style="margin-top:14px;">
            <button class="btn btn-orange" type="submit">Save Changes</button>
            <a class="btn btn-ghost" href="{{ url_for('admin_caselaws') }}">Cancel</a>
          </div>
        </form>
      </div>
    </div></div>
    {% endif %}
    <!-- BULK UPLOAD (File Input) -->
    <div id="panel-bulkupload" class="panel">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">Bulk Upload ‚Äî Excel/CSV File</h2>
        <div class="box">
          <p class="muted">Upload an Excel (.xlsx, .xls) or CSV file with columns matching the database. Existing records with the same Case Law Number will be overwritten.</p>
          <form method="post" action="{{ url_for('admin_bulk_upload') }}" enctype="multipart/form-data">
            <div class="form-group">
              <label>Choose File</label>
              <input type="file" name="file" accept=".csv,.xlsx,.xls" required>
            </div>
            <div class="sheet-toolbar">
              <button class="btn btn-orange" type="submit">‚¨ÜÔ∏è Upload to Database</button>
              <button class="btn btn-ghost" type="button" onclick="document.getElementById('panel-bulkupload').classList.remove('show')">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- SEARCH -->
    <div id="panel-search" class="panel {% if not edit_item and mode!='delete' %}show{% endif %}">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">Search Case Laws</h2>
        <form method="get" action="{{ url_for('admin_caselaws') }}" class="box">
          <div class="search-row">
            <input type="text" name="q" value="{{ q or '' }}" placeholder="Case No., Party, Section, Industry‚Ä¶">
            <input type="hidden" name="page" value="1">
            <input type="hidden" name="per_page" value="{{ per_page or 20 }}">
            <input type="hidden" name="mode" value="edit">
            <button class="btn btn-orange" type="submit">Search</button>
            {% if q %}<a class="btn btn-ghost" href="{{ url_for('admin_caselaws') }}">Clear</a>{% endif %}
            {% if q %}<span class="pill">Filtered</span>{% endif %}
          </div>
        </form>

        <!-- Statistics Table -->
        <table class="stats-table">
          <thead>
            <tr>
              <th>Category</th>
              <th class="count-cell">Count</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Case Laws</td>
              <td class="count-cell">{{ total_case_laws }}</td>
            </tr>
            <tr>
              <td>AAR Case Laws</td>
              <td class="count-cell">{{ aar_case_laws }}</td>
            </tr>
            <tr>
              <td>AAAR Case Laws</td>
              <td class="count-cell">{{ aaar_case_laws }}</td>
            </tr>
            <tr>
              <td>High Court Case Laws</td>
              <td class="count-cell">{{ high_court_case_laws }}</td>
            </tr>
            <tr>
              <td>Supreme Court Case Laws</td>
              <td class="count-cell">{{ supreme_court_case_laws }}</td>
            </tr>
          </tbody>
        </table>

        {% if q %}
        <div style="overflow-x:auto; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th class="col-id">ID</th>
                <th class="col-no">Case No.</th>
                <th>Name of Party</th>
                <th class="col-date">Date</th>
                <th>State</th>
                <th class="col-act">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr>
                <td class="nowrap">{{ r.id }}</td>
                <td class="nowrap" title="{{ r.case_law_number }}">{{ r.case_law_number }}</td>
                <td title="{{ r.name_of_party }}">{{ r.name_of_party }}</td>
                <td class="nowrap">{{ r.date }}</td>
                <td class="nowrap">{{ r.state }}</td>
                <td>
                  <a class="btn" href="{{ url_for('admin_edit_case', rid=r.id) }}">Edit</a>
                  <form style="display:inline;" method="post" action="{{ url_for('admin_delete_case', rid=r.id) }}" onsubmit="return confirmDelete('{{ r.case_law_number|e }}');">
                    <button class="btn btn-danger" type="submit">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
              {% if not rows %}
              <tr><td colspan="6" class="muted">No results.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        {% set pages = (total // per_page) + (1 if total % per_page else 0) %}
        {% if pages > 1 %}
        <div style="margin-top:12px; text-align:right;">
          {% for p in range(1, pages+1) %}
          {% if p == page %}
          <span class="pill">Page {{ p }}</span>
          {% else %}
          <a class="btn" href="?page={{p}}&per_page={{per_page}}&q={{q|urlencode}}&mode=edit">{{p}}</a>
          {% endif %}
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}
      </div>
    </div>
    <!-- DELETE -->
    <div id="panel-delete" class="panel {% if mode=='delete' and not edit_item %}show{% endif %}">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">Delete Case Laws</h2>
        <form method="get" action="{{ url_for('admin_caselaws') }}" class="box">
          <div class="search-row">
            <input type="text" name="q" value="{{ q or '' }}" placeholder="Case No., Party, Section, Industry‚Ä¶">
            <input type="hidden" name="page" value="1">
            <input type="hidden" name="per_page" value="{{ per_page or 20 }}">
            <input type="hidden" name="mode" value="delete">
            <button class="btn btn-orange" type="submit">Search</button>
            {% if q %}<a class="btn btn-ghost" href="{{ url_for('admin_caselaws', mode='delete') }}">Clear</a>{% endif %}
            {% if q %}<span class="pill">Filtered</span>{% endif %}
          </div>
        </form>
        {% if q %}
        <div style="overflow-x:auto; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th class="col-id">ID</th>
                <th class="col-no">Case No.</th>
                <th>Name of Party</th>
                <th class="col-date">Date</th>
                <th class="col-act">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr>
                <td class="nowrap">{{ r.id }}</td>
                <td class="nowrap" title="{{ r.case_law_number }}">{{ r.case_law_number }}</td>
                <td title="{{ r.name_of_party }}">{{ r.name_of_party }}</td>
                <td class="nowrap">{{ r.date }}</td>
                <td>
                  <form style="display:inline;" method="post" action="{{ url_for('admin_delete_case', rid=r.id) }}" onsubmit="return confirmDelete('{{ r.case_law_number|e }}');">
                    <button class="btn btn-danger" type="submit">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
              {% if not rows %}
              <tr><td colspan="5" class="muted">No results.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        {% set pages = (total // per_page) + (1 if total % per_page else 0) %}
        {% if pages > 1 %}
        <div style="margin-top:12px; text-align:right;">
          {% for p in range(1, pages+1) %}
          {% if p == page %}
          <span class="pill">Page {{ p }}</span>
          {% else %}
          <a class="btn" href="?page={{p}}&per_page={{per_page}}&q={{q|urlencode}}&mode=delete">{{p}}</a>
          {% endif %}
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</section>
<script>
function confirmDelete(caseno){
  return confirm("Are you sure you want to permanently delete this case?
Case: " + (caseno|| 'selected record') + "
This action cannot be undone.");
}
</script>
{% endblock %}
